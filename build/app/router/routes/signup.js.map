{"version":3,"sources":["../../../../src/app/router/routes/signup.js"],"names":[],"mappings":";;;;;;AAAA;;;;AACA;;;;AAKA;;;;AAHA,IAAI,SAAS,kBAAQ,MAAR,EAAb;;;;;;;;;AASA,OAAO,GAAP,CAAW,GAAX,EAAgB,UAAC,GAAD,EAAM,GAAN,EAAc;;AAE5B,UAAQ,GAAR,CAAY,+BAAZ;;;AAGA,MAAI,WAAW,IAAI,KAAJ,CAAU,IAAzB;;AAEA,MAAI,CAAC,QAAL,EAAe;;AAEb,QAAI,QAAJ,CAAa,GAAb;AACD,GAHD,MAGO;AACL,YAAQ,GAAR,+BAAyC,QAAzC;AACA,YAAQ,QAAR,EAAkB,GAAlB;AACD;AAEF,CAfD;;;AAkBA,IAAI,UAAU,SAAV,OAAU,CAAC,QAAD,EAAW,GAAX,EAAmB;AAC/B,MAAI,cAAc,6BAAe,QAAf,EAAyB,KAAzB,CAAlB;AACA,oBAAQ,GAAR,CAAY,WAAZ,EAAyB,UAAU,KAAV,EAAiB,QAAjB,EAA2B,IAA3B,EAAiC;AACxD,QAAI,KAAJ,EAAU;AACR,cAAQ,GAAR,CAAY,KAAZ;AACA,UAAI,UAAJ,CAAe,GAAf;AACD,KAHD,MAGO;AACL,UAAI,OAAO,KAAK,KAAL,CAAW,IAAX,CAAX;AACA,cAAQ,GAAR,CAAY,eAAZ;AACA,cAAQ,GAAR,CAAY,IAAZ;AACA,mBAAa,IAAb,EAAkB,GAAlB;AACD;AACF,GAVD;AAWD,CAbD;;;;AAiBA,IAAI,eAAe,SAAf,YAAe,CAAC,IAAD,EAAO,GAAP,EAAe;;AAEhC,MAAI,MAAM,kCAAV;AACA,SAAO,WAAW,KAAK,YAAvB;;AAEA,oBAAQ,GAAR,CAAY,GAAZ,EAAiB,UAAC,KAAD,EAAQ,QAAR,EAAkB,IAAlB,EAA0B;AACzC,QAAI,KAAJ,EAAU;AACR,cAAQ,GAAR,CAAY,KAAZ;AACA,UAAI,UAAJ,CAAe,GAAf;AACD,KAHD,MAGO;AACL,UAAI;AACF,YAAI,WAAW,KAAK,KAAL,CAAW,IAAX,CAAf;AACA,gBAAQ,GAAR,CAAY,QAAZ;;AAEA,YAAI,OAAO;AACT,cAAI,SAAS,OADJ;AAET,eAAI;AACF,mBAAO,KAAK,GAAL,CAAS,gBADd;AAEF,qBAAS,KAAK,GAAL,CAAS,WAFhB;AAGF,uBAAW,SAAS;AAHlB,WAFK;AAOT,qBAAW,SAAS,OAPX;AAQT,eAAK,SAAS,GARL;AAST,gBAAM,SAAS;AATN,SAAX;;AAYA,gBAAQ,GAAR,CAAY,4CAAZ;AACA,gBAAQ,GAAR,CAAY,IAAZ;;AAEA,+BAAS,IAAT,EAAe,QAAf;;;AAGA,gBAAQ,GAAR;AACA,gBAAQ,GAAR,CAAY,gBAAZ;AACA,gBAAQ,GAAR,CAAY,QAAZ;AACA,gBAAQ,GAAR,CAAY,OAAZ;AACA,gBAAQ,GAAR,CAAY,IAAZ;AACA,gBAAQ,GAAR,CAAY,OAAZ;AACA,gBAAQ,GAAR,CAAY,IAAZ;;AAEA,YAAI,IAAJ,CAAS,6BAAT;;;AAGA,+BAAS,IAAT,EAAe,IAAf;AACD,OAlCD,CAkCE,OAAM,CAAN,EAAQ;AACR,gBAAQ,GAAR,CAAY,CAAZ;AACD;AACF;AACF,GA3CD;AA4CD,CAjDD;;kBAmDe,M","file":"signup.js","sourcesContent":["import request from 'request';\nimport express from 'express';\n\nvar router = express.Router();\n\n// bring in helpers\nimport { getAuthAddress, startBot, saveUser } from '../helpers';\n\n// new user creation - redirect from Slack\n// 1. use returned OAuth Code and send back w/ client_id and secret\n// 2. authenticate install w/ returned token\n// 3. start bot and initiate the conversation\nrouter.get('/', (req, res) => {\n\n  console.log(\"STARTING TEAM REGISTRATION...\");\n\n  // temp authorization code\n  var authCode = req.query.code;\n\n  if (!authCode) {\n    // user refused auth\n    res.redirect('/');\n  } else {\n    console.log (`New user with auth code: ${authCode}`);\n    install(authCode, res);\n  }\n\n});\n\n// for when you are first creating slack app\nvar install = (authCode, res) => {\n  var authAddress = getAuthAddress(authCode, \"new\");\n  request.get(authAddress, function (error, response, body) {\n    if (error){\n      console.log(error)\n      res.sendStatus(500)\n    } else {\n      var auth = JSON.parse(body)\n      console.log(\"New user auth\")\n      console.log(auth)\n      registerTeam(auth,res)\n    }\n  });\n}\n\n// after getting access token...\n// first time => register\nvar registerTeam = (auth, res) => {\n  //first, get authenticating user ID\n  var url = 'https://slack.com/api/auth.test?'\n  url += 'token=' + auth.access_token\n\n  request.get(url, (error, response, body) =>{\n    if (error){\n      console.log(error)\n      res.sendStatus(500)\n    } else {\n      try {\n        var identity = JSON.parse(body)\n        console.log(identity)\n\n        var team = {\n          id: identity.team_id,\n          bot:{\n            token: auth.bot.bot_access_token,\n            user_id: auth.bot.bot_user_id,\n            createdBy: identity.user_id\n          },\n          createdBy: identity.user_id,\n          url: identity.url,\n          name: identity.team\n        }\n\n        console.log(\"\\n\\n\\n ~~ bot has been installed ~~ \\n\\n\\n\");\n        console.log(team);\n        // start the bot!\n        startBot(team, \"create\");\n\n        // user has signed up\n        console.log(`User has logged in. Now we must store that session on our server. Authenticate and Authorize the following user properly:`);\n        console.log(\"User identity:\");\n        console.log(identity);\n        console.log(\"Auth:\");\n        console.log(auth);\n        console.log(\"Team:\");\n        console.log(team);\n\n        res.send(\"Your bot has been installed\");\n\n        // this isnt working for some reason\n        saveUser(auth, team)\n      } catch(e){\n        console.log(e);\n      }\n    }\n  })\n}\n\nexport default router;"]}